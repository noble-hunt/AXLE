Pattern Lock + Ban BW Filler in Main Blocks + Higher Hardness Floor

Objective: Guarantee CF/HIIT patterns (E3:00xN, EMOM, AMRAP, 21-15-9, Chipper 40-30-20-10), forbid bodyweight filler in main blocks when equipment exists, and raise hardness default to ≥0.75 with gear (≥0.55 only when readiness is low).

Do this exactly:

Edit server/ai/generators/premium.ts — post-model / pre-return validator:

// Add near top of file:
const ALLOWED_PATTERNS = /(Every\s*[234]:?00\s*x\s*\d+|EMOM\s*(8|10|12|14|16)|AMRAP\s*(8|10|12|15)|For\s*Time\s*21-15-9|Chipper\s*40-30-20-10)/i;
const BANNED_BW_MAIN = /^(Wall Sit|Mountain Climber|Star Jump|High Knees|Jumping Jacks|Bicycle Crunch)$/i;

// Insert function:
function validatePatternsAndBW(workout:any, equipment:string[]) {
  const hasLoad = (equipment||[]).some(e=>/(barbell|dumbbell|kettlebell)/i.test(e));
  const mains = workout.blocks.filter((b:any)=>!['warmup','cooldown'].includes(b.kind));
  if (!mains.length) throw new Error('no_main_blocks');

  for (const b of mains) {
    if (!ALLOWED_PATTERNS.test(b.title||'')) throw new Error('pattern_lock_violation');
    if (hasLoad) {
      const banned = (b.items||[]).filter((it:any)=>BANNED_BW_MAIN.test(it.exercise||''));
      if (banned.length) throw new Error('banned_bw_in_main');
    }
  }
}


Call validatePatternsAndBW(workout, req.equipment) after the model returns. If it throws, regenerate once with a user message reason: "Regenerate with CF pattern lock and remove bodyweight filler from mains (use DB/KB/BB)."

Raise hardness floor (still in premium.ts):

Where you compute variety_score / “hardness”: set the floor to:

0.75 if (equipment includes DB/KB/BB) && (sleep_score >= 60)

0.55 otherwise.

Add penalties/bonuses:

-0.05 if a strength block contains only bodyweight or only push-ups/pull-ups.

+0.03 if a conditioning block pairs cyclical cals with a loaded movement (EMOM odd/even).

Ensure acceptance_flags.hardness_ok === true only if above floor.

Acceptance criteria

Every main block title matches the whitelist regex.

No banned BW is present in mains when equipment exists.

variety_score ≥ 0.75 (or ≥0.55 under low readiness).