Workout Generation API (prod + dev). Fixes 405

Create

api/workouts/generate.ts (POST only; returns JSON)

server/routes/workouts.ts (mount at /api/workouts)

// api/workouts/generate.ts  (Vercel serverless, Node runtime)
import { openai } from '../_openai';
export const config = { runtime: 'nodejs18.x' };

type GenInput = {
  category: string;
  durationMin: number;
  intensity: number;   // 1-10
  equipment?: string[];
  goal?: string;
};

export default async function handler(req: Request) {
  if (req.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method Not Allowed' }), {
      status: 405, headers: { 'content-type': 'application/json' }
    });
  }

  let payload: GenInput;
  try { payload = await req.json(); }
  catch { return json({ error: 'Invalid JSON body' }, 400); }

  if (!process.env.OPENAI_API_KEY) return json({ error: 'OPENAI_API_KEY missing' }, 500);

  const sys = `You generate structured workouts as strict JSON. 
Return ONLY JSON with shape:
{
  "title": string,
  "est_duration_min": number,
  "intensity": number,          // 1-10
  "exercises": [
    { "name": string, "sets": number, "reps": string, "rest_sec": number, "notes": string }
  ]
}`;

  const user = `Category: ${payload.category}
Duration (min): ${payload.durationMin}
Intensity (1-10): ${payload.intensity}
Equipment: ${payload.equipment?.join(', ') || 'bodyweight'}
Goal: ${payload.goal || 'general fitness'}`;

  try {
    const resp = await openai.chat.completions.create({
      model: 'gpt-4o-mini', // small/fast; change if desired
      temperature: 0.4,
      messages: [
        { role: 'system', content: sys },
        { role: 'user', content: user }
      ],
      response_format: { type: 'json_object' }
    });

    const raw = resp.choices?.[0]?.message?.content ?? '{}';
    // Always valid JSON because of response_format, but guard anyway:
    let data: any;
    try { data = JSON.parse(raw); } catch { data = { error: 'LLM returned non-JSON' }; }

    return json({ workout: data }, 200);
  } catch (e: any) {
    console.error('[generate] error', e);
    return json({ error: e?.message || 'generation failed' }, 500);
  }

  function json(x: any, status = 200) {
    return new Response(JSON.stringify(x), {
      status, headers: { 'content-type': 'application/json', 'cache-control': 'no-store' }
    });
  }
}

// server/routes/workouts.ts (Express dev)
import { Router } from 'express';
import { openai } from '../lib/openai';
const router = Router();

router.post('/generate', async (req, res) => {
  const { category, durationMin, intensity, equipment, goal } = req.body ?? {};
  if (!category || !durationMin || !intensity) return res.status(400).json({ error: 'Missing fields' });
  try {
    const sys = `Return ONLY JSON with keys: title, est_duration_min, intensity, exercises[] {name, sets, reps, rest_sec, notes}`;
    const user = `Category: ${category}\nDuration: ${durationMin}\nIntensity: ${intensity}\nEquipment: ${equipment?.join(',') || 'bodyweight'}\nGoal: ${goal || 'general fitness'}`;
    const r = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      temperature: 0.4,
      response_format: { type: 'json_object' },
      messages: [{ role: 'system', content: sys }, { role: 'user', content: user }]
    });
    const raw = r.choices?.[0]?.message?.content ?? '{}';
    const workout = JSON.parse(raw);
    res.json({ workout });
  } catch (e: any) {
    console.error('[dev/generate] err', e);
    res.status(500).json({ error: e?.message || 'generation failed' });
  }
});

export default router;

// server/index.ts  (mount once)
import workoutsRouter from './routes/workouts';
app.use('/api/workouts', workoutsRouter);


Acceptance

Dev & Prod: POST /api/workouts/generate returns 200 with { workout: { ... } }

GET to this path returns 405 (explicit), not a cryptic Vercel 405.