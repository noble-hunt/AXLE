dd a MovementService with seeded, constraint-aware sampling

Goal
Query movements for a given style/pattern/equipment with deterministic randomness (seed).

Do this

Create server/ai/movementService.ts:

import type { Movement, MovementRegistry } from '../types/movements';
import seedrandom from 'seedrandom';
import registryData from '../data/movements.registry.min.json';

type Query = {
  categories?: string[];        // e.g., ['crossfit','olympic_weightlifting']
  patterns?: string[];          // e.g., ['hinge','press','olympic_snatch']
  equipment?: string[];         // available gear
  modality?: ('strength'|'conditioning'|'skill'|'aerobic'|'mobility')[];
  excludeBannedMains?: boolean; // enforce banned_in_main_when_equipment
  levelMax?: 'intermediate'|'advanced';
  limit?: number;
  seed?: string;
};

const MOVES = registryData as MovementRegistry;

function hasAny<T>(arr: T[]|undefined, set: T[]|undefined) {
  if (!arr || !set) return true;
  return arr.some(x => set.includes(x));
}

export function queryMovements(q: Query): Movement[] {
  const equip = (q.equipment||[]).map(s => s.toLowerCase());
  const rng = seedrandom(q.seed || String(Date.now()));

  let pool = MOVES.filter(m => {
    if (q.categories && !q.categories.includes(m.category)) return false;
    if (q.patterns && !hasAny(m.patterns, q.patterns)) return false;
    if (q.modality && !q.modality.includes(m.modality)) return false;
    if (q.excludeBannedMains && m.banned_in_main_when_equipment && equip.length) return false;
    if (equip.length) {
      // If any equipment tag matches available OR movement is bodyweight/mobility
      if (!m.equipment.some(e => equip.includes(e) || e === 'bodyweight' || e === 'mobility')) return false;
    }
    return true;
  });

  // Weighted: prefer external load when equipment exists
  const weighted = pool.flatMap(m => {
    const hasLoad = m.equipment.some(e => ['barbell','dumbbell','kettlebell','machine','cable','sandbag','sled'].includes(e));
    const w = hasLoad ? 3 : 1; // adjust later if needed
    return Array(w).fill(m);
  });

  // Deterministic shuffle by seed
  for (let i = weighted.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    const t = weighted[i]; weighted[i] = weighted[j]; weighted[j] = t;
  }
  const uniqueById = new Map<string, Movement>();
  for (const m of weighted) {
    if (!uniqueById.has(m.id)) uniqueById.set(m.id, m);
    if (q.limit && uniqueById.size >= q.limit) break;
  }
  return [...uniqueById.values()];
}


Acceptance

queryMovements({categories:['crossfit'], patterns:['hinge'], equipment:['barbell'], limit:5, seed:'X'}) returns 5 deterministic loaded movements (e.g., deadlift variants/KB swing/wall balls).

With excludeBannedMains:true, you never see wall sits, star jumps, mountain climbers when equipment exists.